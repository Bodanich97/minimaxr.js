"use strict";function MxAnalysisCache(){this.Nodes=new Array,this.Cursor=0,this.RetrieveAnalysis=function(player,depth,position){for(var n in this.Nodes){var entry=this.Nodes[n];if(entry.Player===player&&!(entry.Depth<depth)&&entry.Position.Equals(position))return entry.Analysis}return null},this.CacheAnalysis=function(player,depth,position,analysis){var myentry=new Object;myentry.Depth=depth,myentry.Position=position.Clone(),myentry.Analysis=analysis,this.Cursor>=analysisCacheSize&&(this.Cursor=0),this.Nodes[this.Cursor]=myentry,this.Cursor++}}function MxPositionAnalysis(dynamicValue,staticValue,potentialValue,bestMove){this.DynamicValue=dynamicValue,this.StaticValue=staticValue,this.PotentialValue=potentialValue,this.BestMove=bestMove}function MxPosition(){this.Nodes=new Array;for(var sq=0;40>=sq;sq=NextSquare(sq))this.Nodes[sq]=1;for(var sq=40;60>sq;sq=NextSquare(sq))this.Nodes[sq]=0;for(var sq=60;100>sq;sq=NextSquare(sq))this.Nodes[sq]=-1;this.LegalMovesX=function(player,square,direction,captureMode){try{for(var legalMoves=new Array,sq=0;100>sq;sq=NextSquare(sq)){var man=this.Nodes[sq];if(player*man>0&&(square==sq||null==square))for(var dir=0;4>dir;dir++)if((IsLegalDirection(player,dir)||IsKing(man)||captureMode)&&(direction==dir||null==direction))if(captureMode){var moveSegment=new Array,capture=this.GetCapture(sq,dir),perpendicularContinuationsFound=!1,lastLandingSquare=null;if(null==capture)continue;do{perpendicularContinuationsFound=!1,moveSegment=moveSegment.concat(capture),this.ExecuteMove(capture),lastLandingSquare=moveSegment[moveSegment.length-3];do{var legalContinuations=this.LegalMovesX(player,TerminalSquare(moveSegment),PreviousDirection(dir),!0);legalContinuations=legalContinuations.concat(this.LegalMovesX(player,TerminalSquare(moveSegment),NextDirection(dir),!0));for(var m in legalContinuations)legalMoves[legalMoves.length]=NormalizeMove(moveSegment.concat(legalContinuations[m])),perpendicularContinuationsFound=!0}while(this.AdvanceTerminalSquare(moveSegment,dir));capture=this.GetCapture(TerminalSquare(moveSegment),dir)}while(null!=capture);if(!perpendicularContinuationsFound)for(legalMoves[legalMoves.length]=NormalizeMove(moveSegment);TerminalSquare(moveSegment)!==lastLandingSquare;){this.AdvanceTerminalSquare(moveSegment,OppositeDirection(dir));legalMoves[legalMoves.length]=NormalizeMove(moveSegment)}this.UndoMove(NormalizeMove(moveSegment))}else for(var nextSquare=NextSquare(sq,dir,1);this.IsFreeSquare(nextSquare)&&(legalMoves[legalMoves.length]=NormalizeMove(new Array(sq,man,0,nextSquare,0,man)),IsKing(man));)nextSquare=NextSquare(nextSquare,dir,1)}return legalMoves}catch(err){alert("LegalMovesX Error: "+err)}},this.LegalMoves=function(player){try{var legalMoves=this.LegalMovesX(player,null,null,!0);return 0===legalMoves.length&&(legalMoves=this.LegalMovesX(player,null,null,!1)),legalMoves}catch(err){alert("Legal Moves generation error: "+err)}},this.Clone=function(){for(var p=new MxPosition,s=0;100>s;s=NextSquare(s))p.Nodes[s]=this.Nodes[s];return p},this.Equals=function(pos){for(var s=0;100>s;s=NextSquare(s))if(pos.Nodes[s]!=this.Nodes[s])return!1;return!0},this.Analysis=function(player,depth,parentBestValue,parentDepth,untilQuiescent){try{var legalMoves=this.LegalMoves(player);if(0===legalMoves.length)return new MxPositionAnalysis(minimumPositionValue,minimumPositionValue,minimumPositionValue,null);if(depth>=minAnalysisCacheDepth&&useAnalysisCache){var cachedAnalysis=AnalysisCache.RetrieveAnalysis(player,depth,this);if(null!=cachedAnalysis)return cachedAnalysis}if(0===depth){if(!(untilQuiescent&&maximumSearchDepth>parentDepth&&CaptureCount(legalMoves[0])>0))return new MxPositionAnalysis(this.StaticValue(player),this.StaticValue(player),minimumPositionValue,legalMoves[0]);depth=quiescenceExtensionDepth}var bestValue=maximumPositionValue,bestPotentialValue=maximumPositionValue,bestChildMove=null,myPotentialValue=0,hit=!1;for(var m in legalMoves){this.ExecuteMove(legalMoves[m]);var analysis=this.Analysis(-player,depth-1,bestValue,parentDepth+1,untilQuiescent);if(this.UndoMove(legalMoves[m]),myPotentialValue+=analysis.PotentialValue,(analysis.DynamicValue<bestValue||analysis.DynamicValue==bestValue&&analysis.PotentialValue<bestPotentialValue)&&(bestValue=analysis.DynamicValue,bestPotentialValue=analysis.PotentialValue,bestChildMove=legalMoves[m],hit=!0),-bestValue>=parentBestValue&&useAlphaBetaPruning)break}hit===!1&&console.log("not hit");var myAnalysis=new MxPositionAnalysis(-bestValue,this.StaticValue(player),-myPotentialValue,bestChildMove);return useAnalysisCache&&AnalysisCache.CacheAnalysis(player,depth,this,myAnalysis),myAnalysis}catch(err){alert("Error performing analysis: "+err)}},this.ValueProfile=function(player){for(var valueProfile=new Array,d=0;minimumSearchDepth>d;d++)valueProfile[d]=this.DynamicValue(player,d,maximumPositionValue,0,!1);return valueProfile[minimumSearchDepth]=this.DynamicValue(player,d,maximumPositionValue,0,useQuiescenceSearch),valueProfile},this.IsValidSquare=function(sq){try{var ssq=sq.toString();if(1===ssq.length&&(ssq="0"+ssq),2!==ssq.length)return!1;var row=parseInt(ssq.charAt(0)),col=parseInt(ssq.charAt(1));return row%2===0&&col%2===0||row%2===1&&col%2===1}catch(err){alert("IsValidSquare error: "+err)}},this.IsFreeSquare=function(sq){return this.IsValidSquare(sq)&&0===this.Nodes[sq]},this.ManCount=function(player){for(var c=0,sq=0;100>sq;sq=NextSquare(sq))(AreComrades(this.Nodes[sq],player)||null==player)&&c++;return c},this.StaticValue=function(player){return this.ManCount(player)-this.ManCount(-player)},this.GetCapture=function(square,direction){try{var mycapture=null,man=this.Nodes[square],nextSquare=NextSquare(square,direction,1);if(IsKing(man))for(;this.IsFreeSquare(nextSquare);)nextSquare=NextSquare(nextSquare,direction,1);var landingSq=NextSquare(nextSquare,direction,1);return this.Nodes[nextSquare]*man<0&&this.IsFreeSquare(landingSq)&&(mycapture=new Array(square,man,0,nextSquare,this.Nodes[nextSquare],0,landingSq,0,man)),mycapture}catch(err){alert("GetCapture error"+err)}},this.ExecuteMove=function(move){try{for(var x=0;x<move.length;x+=3)this.Nodes[move[x]]=move[x+2]}catch(err){alert("ExecuteMove Error: "+err)}},this.UndoMove=function(move){try{for(var x=0;x<move.length;x+=3)this.Nodes[move[x]]=move[x+1]}catch(err){alert("UndoMove Error: "+err)}},this.AdvanceTerminalSquare=function(move,dir){try{var finalMan=move[move.length-1];return this.Nodes[move[move.length-3]]!==finalMan&&alert("AdvanceTerminalSquare problem"),IsKing(finalMan)&&this.IsFreeSquare(NextSquare(TerminalSquare(move),dir,1))?(this.Nodes[NextSquare(TerminalSquare(move),dir,1)]=finalMan,this.Nodes[TerminalSquare(move)]=0,move[move.length-3]=NextSquare(TerminalSquare(move),dir,1),!0):!1}catch(err){alert("AdvanceTerminalSquare error"+err)}}}function MxGame(){this.MoveHistory=new Array,this.Position=new MxPosition,this.Turn=-1,this.BestMove=function(){return this.Position.Analysis(this.Turn,minimumSearchDepth,maximumPositionValue,0,useQuiescenceSearch).BestMove},this.TryAcceptMove=function(startSquare,endSquare){var legalMoves=this.Position.LegalMoves(this.Turn);for(var m in legalMoves){var move=legalMoves[m];if(move[0]===startSquare&&move[move.length-3]===endSquare)return this.Position.ExecuteMove(move),this.MoveHistory[this.MoveHistory.length]=move,!0}return!1}}function NormalizeMove(move){try{for(var rootMan=move[1],mv=new Array(move[0],move[1],move[2]),x=3;x<move.length-3;x+=3)AreComrades(rootMan,move[x+1])||AreComrades(rootMan,move[x+2])||(mv[mv.length]=move[x],mv[mv.length]=move[x+1],mv[mv.length]=move[x+2]);return mv[mv.length]=move[move.length-3],mv[mv.length]=move[move.length-2],mv[mv.length]=move[move.length-1],!IsKing(mv[mv.length-1])&&(1==rootMan&&mv[mv.length-3]>=91||-1==rootMan&&mv[mv.length-3]<=8)&&(mv[mv.length-1]=10*mv[mv.length-1]),mv}catch(err){alert("Move normalization error: "+err)}}function TerminalSquare(move){return move[move.length-3]}function NextSquare(sq,dir,steps){try{switch(null==sq&&(sq=0),null==steps&&(steps=1),dir){case northEast:return sq+9*steps;case southEast:return sq-11*steps;case southWest:return sq-9*steps;case northWest:return sq+11*steps;default:switch(sq.toString().charAt(sq.toString().length-1)){case"8":return sq+3;case"9":return sq+1;default:return sq+2}}}catch(err){alert("NextSquare error:"+err)}}function CaptureCount(move){return move.length/3-2}function IsKing(man){return man*man>1}function AreComrades(man1,man2){return man1*man2>0}function OppositeDirection(direction){return(direction+2)%4}function NextDirection(direction){return(direction+1)%4}function PreviousDirection(direction){return OppositeDirection(NextDirection(direction))}function IsLegalDirection(player,dir){return 1===player?dir===northEast||dir===northWest:dir===southEast||dir===southWest}function Stealth(valueProfile){return valueProfile.avg()-valueProfile.last()}Object.defineProperty(exports,"__esModule",{value:!0}),require("babel-polyfill");var minimumSearchDepth=5,maximumSearchDepth=9,useProgressiveDeepening=!0,useQuiescenceSearch=!0,useAlphaBetaPruning=!0,useAnalysisCache=!0,useSingularExtensions=!1,analysisCacheSize=4e3,minAnalysisCacheDepth=3,useAdvancedAnalysisCacheAging=!1,useOpponentModeling=!0,quiescenceExtensionDepth=2,minimumPositionValue=-999,maximumPositionValue=999,minimumManCount=2,initialManCount=20,northEast=0,southEast=1,southWest=2,northWest=3,AnalysisCache=new MxAnalysisCache;exports["default"]=MxGame;